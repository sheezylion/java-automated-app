---
# Install Java 11 (Amazon Corretto â€“ correct for AL2023)
- name: Install Java 11
  dnf:
    name:
      - java-11-amazon-corretto
      - tar
    state: present

# Download Tomcat
- name: Download Apache Tomcat 9
  get_url:
    url: https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.85/bin/apache-tomcat-9.0.85.tar.gz
    dest: /tmp/apache-tomcat-9.0.85.tar.gz
    mode: "0644"

# Extract Tomcat
- name: Extract Tomcat
  unarchive:
    src: /tmp/apache-tomcat-9.0.85.tar.gz
    dest: /opt
    remote_src: yes
    creates: /opt/apache-tomcat-9.0.85

# Create Tomcat symlink
- name: Create Tomcat symlink
  file:
    src: /opt/apache-tomcat-9.0.85
    dest: /opt/tomcat
    state: link

# Set ownership
- name: Ensure Tomcat ownership
  file:
    path: /opt/apache-tomcat-9.0.85
    owner: ec2-user
    group: ec2-user
    recurse: yes

# Install Tomcat systemd service
- name: Install Tomcat systemd service
  copy:
    dest: /etc/systemd/system/tomcat.service
    mode: "0644"
    content: |
      [Unit]
      Description=Apache Tomcat
      After=network.target

      [Service]
      Type=forking
      User=ec2-user
      Group=ec2-user

      Environment=JAVA_HOME=/usr/lib/jvm/java-11-amazon-corretto
      Environment=CATALINA_HOME=/opt/tomcat
      Environment=CATALINA_BASE=/opt/tomcat
      Environment=CATALINA_PID=/opt/tomcat/temp/tomcat.pid

      ExecStart=/opt/tomcat/bin/startup.sh
      ExecStop=/opt/tomcat/bin/shutdown.sh

      Restart=on-failure

      [Install]
      WantedBy=multi-user.target

# Reload systemd to pick up Tomcat service
- name: Reload systemd
  systemd:
    daemon_reload: yes

# Enable and start Tomcat
- name: Enable and start Tomcat
  systemd:
    name: tomcat
    state: started
    enabled: yes
